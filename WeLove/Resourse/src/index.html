<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>首页地图</title>
    <script type="text/javascript">
        (function (doc, win) {
            var docEl = doc.documentElement,
                    resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                    recalc = function () {
                        var clientWidth = docEl.clientWidth;
                        if (!clientWidth) return;
                        docEl.style.fontSize = 20 * (clientWidth / 375) + 'px';
                    };
            if (!doc.addEventListener) return;
            win.addEventListener(resizeEvt, recalc, false);
            doc.addEventListener('DOMContentLoaded', recalc, false);
        })(document, window);

        var _getRequest = {
            constructor:function(){
                var url = decodeURIComponent(location.search);
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                    strs = str.split("&");
                    for(var i = 0; i < strs.length; i ++) {
                        theRequest[strs[i].split("=")[0]]=decodeURIComponent(strs[i].split("=")[1]);
                    }
                }
                return theRequest;
            },
            getInfo:function(info){
                if(typeof(_getRequest.constructor()[info])=="undefined"){
                    return "undefined";
                }else{
                    return _getRequest.constructor()[info].replace( /\r|\n/g, "" );
                }
            }
        }
    </script>
    <link rel="stylesheet" href="assets/css/libs/leaflet.css" />
    <link rel="stylesheet" href="assets/icon.css" />
</head>
<style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #mapid {
        height: 100%;
    }
    .leaflet-control-attribution a{
        display: none;
    }
    .home-crop{
        color:#fff;
        font-size: 0.4rem;
        width: 26px !important;
        height: 26px !important;
        line-height: 26px !important;
        border-radius: 50%;
        padding: 1px;
        text-align: center;
        border: 1px solid #fff;
    }
    .iconcolor{
        color: #444;
        font-size: 1rem;
    }
</style>
<body id="app">
<div id="mapid"></div>
<script src="assets/js/libs/vue/vue.min.js"></script>
<script src="assets/js/libs/vue/vue-resource.min.js"></script>
<script src="assets/js/libs/leaflet/leaflet.js"></script>
<script src="assets/js/libs/jquery.min.js"></script>
<script>
    function isEmptyObject(obj) {
        for (var key in obj) {
            return false;
        }
        return true;
    }

    var App = new Vue({
        el: '#app',
        data: {
            user_id:_getRequest.getInfo('user_id'),
            SESSION:function(){return _getRequest.getInfo('SESSION')},
            map:L.map('mapid',{zoomControl: false}),
            geometry:[]
        },
        methods:{
            popWin:function(field_id){
                window.AndroidWebView.openActivity(field_id);
            }
        },
        created:function(){
            L.tileLayer("http://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}", {
                maxZoom: 20,
                attribution: '地图数据 &copy;安徽阡陌网络科技有限公司' ,
                id: 'mapbox.streets'
            }).addTo(this.map);

            L.control.zoom({
                position:'bottomleft'
            }).addTo(this.map);
        },
        ready:function(){
            this.$http.get('http://60.169.69.3:9001/api/home/sensorlist',{user_id:this.user_id,SESSION:this.SESSION},function(data) {
//            this.$http.get('http://192.168.5.54:8081/api/home/sensorlist',{user_id:this.user_id,SESSION:this.SESSION},function(data) {
                var cgxdata=data.data;
//                如果有传感器的话
                if(cgxdata[0]){
                    cgxdata.forEach(function(e,j){
                        console.log(e)
                        switch (cgxdata[j].peng_class){
                            case 1:
                                cgxdata[j].icon="chuanganqi";
                                break;
                            case 2:
                                cgxdata[j].icon="qixiangzhan";
                                break;
                            default:
                                cgxdata[j].icon="chuanganqi";
                                break;
                        }
                        const myIcon = L.divIcon({className: 'iconcolor icon-'+cgxdata[j].icon});
                        L.marker(cgxdata[j].sensor_geo, {icon: myIcon}).addTo(App.map)
                    });
//                    for(var j=0;j<cgxdata.length;j++){
//                        switch (cgxdata[j].peng_class){
//                            case 1:
//                                cgxdata[j].icon="chuanganqi";
//                                break;
//                            case 2:
//                                cgxdata[j].icon="qixiangzhan";
//                                break;
//                            default:
//                                cgxdata[j].icon="chuanganqi";
//                                break;
//                        }
//                        const myIcon = L.divIcon({className: 'iconcolor icon-'+cgxdata[j].icon});
//                        L.marker(cgxdata[j].sensor_geo, {icon: myIcon}).addTo(this.map)
//                    }
                }
            });
            this.$http.get('http://60.169.69.3:9001/api/home/fieldlist',{user_id:this.user_id,SESSION:this.SESSION},function(data) {
//            this.$http.get('http://192.168.5.54:8081/api/home/fieldlist',{user_id:this.user_id,SESSION:this.SESSION},function(data) {
                var data = data.data;
                if(isEmptyObject(data)){
                    this.map.setView([31.015337, 118.326863], 14);
                }else{
                    //开始绘制文字
                    for(var j=0;j<data.length;j++){
                        var geozb = JSON.parse(data[j].geometry);
                        var LatLng = L.latLngBounds(geozb).getCenter();
//                        当crops中有数据的时候
                        if(data[j].crops[0]){
//                            取所有的crop_nickname放在crops的第一个crop里面
                            var names='';
                            for(var k=0;k<data[j].crops.length;k++){
                                names+=data[j].crops[k].crop_nickname;
                                data[j].crops[0].crop_nickname=names;
                            }
                            
                            var cropIcon = L.divIcon({className: 'home-crop', html: data[j].crops[0].crop_nickname});
                            L.marker(LatLng, {icon: cropIcon}).addTo(this.map);
                        }
                    }
//                    1: '#fbbbbd', // 水稻
//                    2: '#c2c3c4', // 龙虾
//                    3: '#bdfffe', // 鱼
//                    4: '#b0b5de' // 鳖
                    data.forEach(function(e,i){
                        var style = {
                            color: "#fbbbbd",
                            opacity: 0.5,
                            weight: 1,
                            fillColor: "#fbbbbd",
                            fillOpacity: 0.4
                        };
                        if(data[i].crops[0]){
                            switch (data[i].crops[0].crop_nickname){
                                case '稻':
                                    style.color="#fbbbbd"
                                    style.fillColor="#fbbbbd"
                                    break;

                                case '虾':
                                    style.color="#c2c3c4"
                                    style.fillColor="#c2c3c4"
                                    break;
                                case '鱼':
                                    style.color="#bdfffe"
                                    style.fillColor="#bdfffe"
                                    break;
                                case '鳖':
                                    style.color="#b0b5de"
                                    style.fillColor="#b0b5de"
                                    break;
                                default:
                                    break;
                            }
                        }
                        var latlngs=[];
                        if (typeof data[i].geometry === 'string') data[i].geometry = JSON.parse(data[i].geometry);
                        var latlngs = latlngs.concat(data[i].geometry);
                        App.map.fitBounds(latlngs);
                        L.polygon(data[i].geometry, style).addTo(App.map).on('click',function(){
                            App.popWin(data[i].field_id);
                        });
                    });
                    this.map.setZoom(17);
//                    this.map.fitBounds(this.geometry);  //画上多边形
                }
                $(".leaflet-control-attribution").html("地图数据 &copy;安徽阡陌网络科技有限公司");
            });
        }
    });
</script>
</body>
</html>
